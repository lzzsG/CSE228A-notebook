## 开源项目开发

### 想象理想代码的样子

理想的代码应该具备以下特征：

- 正确性
  - 始终输出正确的结果。
  - 如果输入不合法，能清晰地告知错误信息。
  - 不仅要正确，还要让开发者确信其正确性。
- 易于理解和使用
  - 有完整的文档。
  - 代码本身清晰、易读、易修改。
- 高效性
  - 性能已经优化到几乎无可提升的程度。

但几乎不可能在代码的第一版中实现所有这些目标，因此需要不断**修改和改进**。

### 今日计划

- 持续集成 (Continuous Integration, CI)
- 代码管理
- 文档化
- 开源化

### 持续集成 (Continuous Integration, CI)

#### 为什么需要持续集成？

在快速开发的过程中，**bug** 会不可避免地出现在项目中：

- Bug 可能从一开始就存在，但只有在后续阶段才显现。
- Bug 可能出现在组件之间的交互中。

**解决方案**：使用共享资源，自动化运行测试（持续集成）。

- **示例**：在每次提交代码或拉取请求时，自动运行测试。
- 高频测试可以更早发现问题，并减少人工调试的工作量。

#### 持续集成的额外好处

- 测试的作用超越了项目内部开发：
  - 公开使用 CI，让他人看到你在运行测试。
  - 可以用于检查贡献者的代码（无论是内部开发者还是外部贡献者）。
  - 依赖项目的开发者可以观察其更改是否会破坏下游项目。

### 设置 CI 的必要条件

#### 测试

- 项目中应该具备测试，CI 的出现会让**高质量的测试变得更有价值**。
- 如果担心某些代码通过了测试却仍然有 Bug？那就**提高测试覆盖率**。

#### 脚本与自动化

- 可以利用许多现成的资源与工具。
- 除了编写测试代码，设置 CI 的主要工作就是自动化。

#### 执行环境

- 测试可以在本地或云端运行。
- GitHub 提供简单且免费的解决方案，例如 **GitHub Actions**。

### 考虑更多测试类型（适用于 CI）

1. 单元测试（Unit Test）
   - 测试模块或组件的单独功能，是测试套件的核心部分。
2. 集成测试（Integration Test）
   - 结合多个（或所有）组件，验证它们能否协同工作。
3. 回归测试（Regression Test）
   - 确保之前运行正常的功能仍然有效。
   - 可以尝试用旧的编译器或依赖的旧版本运行测试。
4. 冒烟测试（Smoke Test）
   - 检查核心功能是否能正常运行。
   - 如果失败，系统显然是坏的。
5. 性能测试（Performance Test）
   - 确保项目在功耗、性能、面积（PPA）方面没有退步。

#### 示例：“让工具完成工作”

- 与人工调试相比，让服务器运行测试更简单、更高效。
- CI 可能运行比本地开发时更多、更广泛的测试。
- 根据 CI 运行的场景，可以选择运行不同类型的测试。

## 代码管理

使用版本控制工具（如 **Git**）是软件开发中的必备技能，因为它能带来以下好处：

- 跟踪代码的变更历史，查看不同版本，轻松实现团队协作。

### Git 仓库中的内容管理

- **Git 子模块（Git Submodules）**
  - 允许在某一特定提交版本下引入另一个 Git 仓库。
  - 建议减少使用子模块，或将所有内容放入单一仓库中，仅在需要独立使用的情况下将内容放入单独仓库。
  - 子模块最适用于追踪尚未发布的外部依赖。
- **Git 分支（Branches）管理**
  - 推荐保持少量长期使用的分支。
  - 分支过多会增加管理复杂度。
- **拉取请求（Pull Requests）**
  - 是一种系统化合并代码的方法。
  - 可用于选择是否接受贡献，并在合并前进行代码评审（Code Review）。

## 代码评审动机

如果回想一下，你会发现许多已经完成的代码实际上像一份**草稿**：

- 当代码“能跑通”且“完成”后，你是否回去清理过这些代码？
- 清理了多少？尝试改进了什么？

与书写文本的过程进行对比：

- 写一篇草稿只是开始。
- 即使内容正确，仍需要多次修订/重写以提高**可读性**和**清晰性**。
- 同样，代码也需要外界反馈以不断改进。

## 代码评审总结

代码评审是通过他人的帮助来提升代码质量的一种方式：

- 发现潜在问题
  - 他人可能会发现你未曾考虑到的弱点或问题。
  - 最低限度也会帮助代码变得更加一致和清晰。
- 增加代码的可读性
  - 代码的阅读频率远高于它的编写频率（即使是自己写的代码），因此可读性很重要。

### 代码评审的好处

- 经评审的代码通常会更优秀，或者至少保持一致性。
- 准备代码评审的过程会促使贡献者在评审前就尽可能完善代码。
- 通过查看、讨论和接收代码反馈，你会成长为一名更好的开发者。

## 代码评审过程

1. **提出评审请求**
   - 通常由代码创建者请求他人对代码贡献进行评审。
   - 有些项目会要求明确提出评审请求。
2. **评审者审阅代码**
   - 提出改进建议或请求。
   - 评审工具可以方便地为讨论点添加注释。
3. **提交者修订代码**
   - 根据反馈修改代码并再次提交评审（可能需要多轮）。
4. **评审者批准代码**
   - 最终批准代码并接受贡献。

## 代码评审需要关注的点

每个项目或组织可能有自己的评审政策和清单，但以下是一些通用的检查点：

### **正确性**

- 是否存在潜在问题？
  - 通过测试和 CI 是基本要求，但是否还有其他需要关注的情况？

### **可读性/代码风格**

- 代码是否清晰？是否遵循规范？
  - 是否可以建议不同的代码组织方式或命名，以提升代码的可读性和可维护性？
  - 可使用工具（如 **Scalastyle**）检查代码风格问题（linter）。

### **完整性**

- 是否包含足够的测试和文档？

### **其他因素**

- 代码是否合适？是否需要引入新的问题或改动？

## 文档的重要性

文档在软件开发中起到多种关键作用：

- **概述**：总结项目的功能和目标。
- **使用说明**：指导用户如何使用项目或工具。
- **详细信息**：描述项目的内部结构和功能实现。

缺少文档会对潜在用户和贡献者造成最大程度的阻碍，而完善的文档可以带来多种好处：

- 吸引用户和贡献者，提升项目的社区参与度。
- 促使开发者从用户的角度重新审视项目：
  - 这可能有助于对功能或接口进行有益的重新设计和优化。

## 常用的文档工具

### **README 文件**

- 是代码仓库中的

  最低要求

  ，用来快速概述项目。

  - 对于小型项目尤其实用，编写简单且易于维护。
  - 如果以 Markdown 格式编写，GitHub 会在代码页面自动渲染。

### **Scaladoc**

- 专为 Scala 项目设计，直接用于代码的 API 文档生成：
  - 使用特殊注释为代码添加详细说明，并生成美观的 HTML 文档。
  - 某些 IDE 可直接渲染或与 Scaladoc 集成，方便开发过程中的即时查看。
  - 文档紧贴代码，易于保持同步更新。

### **静态站点**

- 非常适合进行主题导向的详细解释（例如项目的背景、使用案例等）。
  - **ReadTheDocs** 是一个非常有用的文档编写和托管服务，支持 Markdown 和 Sphinx 等格式。

## 编写文档的建议

### 1. **概述功能与目标**

文档中应包含项目整体功能或目标的简要总结，帮助用户快速了解项目的核心价值。

### 2. **关注功能，而非实现细节**

- 强调项目**能做什么（功能）**，而不是**如何实现（内部工作原理）**。
- 过多的实现细节可能让文档显得晦涩难懂，降低用户体验。

### 3. **注重交互，而非抽象**

- 文档应优先描述**如何使用项目**（交互方式），而非介绍过多的抽象概念。
- 例如，给出使用示例和应用场景，而非解释复杂的底层逻辑。

### 4. **发现难以解释的内容时重新审视**

- 如果某个功能、问题或 API 很难用文档解释清楚，可能是其设计存在问题：
  - 它可能过于复杂，值得重新设计以提高清晰度和可用性。

## 为什么开源你的项目？

开源可以带来许多好处：

### 1. **通过你的工作帮助世界**

- **研究人员**：可以通过开源共享知识并促进学术研究。
- **公司**：即使代码不是核心竞争力，也可以选择开源以推动创新或社区合作。

### 2. **社区可以改进你的代码**

- **外部贡献者**可以添加新功能、修复错误并提升性能。
- 更广泛的使用会暴露潜在问题，帮助你持续改进。

### 3. **提升个人影响力**

- 开源可以将你的贡献暴露于更广阔的圈子中，提升个人知名度。
- 人们往往尊重那些创建并维护常用工具或代码库的人。

### 4. **为什么不呢？**

- **回馈开源社区**：你自己可能已经从开源项目中受益良多，因此可以通过开源回馈。
- **没有法律风险**：如果不存在专利或商业影响，开源是一个不错的选择。

## 成功开源项目的要素

1. **实用性**：项目应该能解决实际问题或提供有用的功能。
2. **功能正确**：项目需要经过充分的测试以确保可靠性。
3. **文档完善**：没有文档的项目难以吸引用户和贡献者。
4. **开源许可证**：明确许可条件以允许他人合法使用和修改代码。

## 开源许可证

当你创建了一个原创代码时，自动拥有该代码的**版权**。即使将其发布到公共平台，其他人也不能随意使用。这时，需要通过开源许可证授予他人使用权限。

### **许可证的作用**

- 授权他人在一定条件下使用、修改或分发代码。
- 不同的开源许可证有不同的权限和限制，例如：
  - 商业用途是否允许？
  - 是否需要共享修改后的代码？
  - 是否包含专利许可？

### **常见许可证**

1. **BSD & MIT**
   - **宽松许可证**，允许广泛的使用和修改。
   - 常见于学术项目、工业或个人项目。
2. **GPL (v3)**
   - **Copyleft许可证**，要求修改后的代码也必须开源。
   - 广泛应用于社区项目，但对某些公司可能有限制。
3. **Apache (v2)**
   - 类似BSD & MIT，但包括**专利许可**。
   - 减少大公司因专利问题使用代码的风险。
4. **Unlicense & WTFPL**
   - **极宽松许可证**，几乎将代码贡献给公共领域。

### **将许可证放在哪里？**

- 将许可证文件命名为 `LICENSE` 并放置在代码根目录下。
- GitHub 会尝试自动检测并显示许可证类型。
- 可使用 SPDX 标准化工具，让许可证更易于识别。

## 吸引贡献者参与项目

1. **项目需要有趣且有用**
   - 项目内容要吸引人，能引起开发者兴趣。
   - 确保项目能正常工作，通过足够的测试。
2. **完善文档**
   - 明确项目目标和贡献流程。
   - 指导用户和贡献者如何使用或扩展项目。
3. **积极响应社区反馈**
   - 及时处理问题（Issue）和合并请求（Pull Request）。
   - 提供有效的帮助资源，例如邮件列表、gitter或专用标签（StackOverflow）。
4. **建议参与方向**
   - 提供清晰的改进建议或未完成的功能列表，以激发贡献者的兴趣。

## 具体尝试的事项

- **持续集成（CI）**
- **代码审查**
- **文档编写**
- **发布开源版本**

## 示例：Chisel3 的开源实践

- **CI**：GitHub Actions 配置与仪表板。

- **代码审查**：在 Pull Request 中提供示例。

- 文档：

  - 使用 Scaladoc 自动生成 API 文档，并提供结果链接。
  - 静态站点展示功能概览和详细说明。

- **许可证**：包括清晰的 LICENSE 文件。
